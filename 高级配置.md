# 高级使用与配置
```
配置IP黑白名单,验证参数签名,返回数据格式化,配置访问拦截
```
## Program.cs
```C#
var builder = WebApplication.CreateBuilder(args);
var sqlConnectionString = builder.Configuration.GetConnectionString("DbContext");
builder
    .Logging
    .AddConsole()
    //配置数据库日志记录
    .AddSqlServer(option => {
        option.ConnectionString= sqlConnectionString;
    })
    .Services
    //配置EF
    .AddDbContextPool<DataContext>(option =>
    {
        option.UseSqlServer(sqlConnectionString);
    })
    //配置接口
    .AddGateaway(option => {
        //设置编码
        option.Encoding = Encoding.UTF8;
        //验证参数 args:IDictionary<string, string>
        //返回 true验证成功,返回false 验证失败,返回msg
        option.OnVerifyPrameters = (args, context) => (true,"ok");
        //验证签名, 自定义签名算法,比如MD5 返回true:成功,false:失败
        option.OnVerifySign = (args, context) => true;
        //验证ip ,这里IP可能是多个IP以逗号分割,需要自己处理,或者自己使用context获取IP 
        option.OnVerifyIP = (context, ip) => true;
        //访问开始事件
        //如果需要获取提交的参数  使用Task<IDictionary<string, object>> args= context.GetPrametersAsync()
        option.OnBeginRequest =async context =>await Task.CompletedTask;
        //访问结束事件
        option.OnEndReqeust = async context => await Task.CompletedTask;
        //格式化返回参数
        //status(bool):执行状态
        //code(int):状态代码
        //message(string):执行结果消息,如果发生错误则为错误消息
        //data(object):返回数据
        //需要安装  Virtuesoft.Framework.JsonExtensions 扩展
        option.OnFormatResult = (status, code, message, data) => new
            {
                s = status, c = code, m = message, d = data
            }.ToJson();

    });
    
var app = builder.Build();
//使用接口
app.UseGateaway();
app.Run("http://*:5000");
```
## 多级路由方法配置
```
默认路由 
get: http://*:5000/user/get?id=10000
post:http://*:5000 json:{method:"user.get",id:10000}
多级路由
//默认 user
public class UserGateaway:GateawayBase
{
    ILogger<UserGateaway> Logger { get; }
    DataContext Db { get; }
    public UserGateaway(DataContext context,ILogger<UserGateaway> logger)
    {
        Logger=logger;
        Db = context;
    }
    //获取用户手机号
    //默认 user.phone
    public async Task<object> Phone(){
        var user=Db.Accounts.Find(User.Id);//Base.User 当前登录的用户
        ...
    }
    // 修改用户手机号
    // user.phone.update
    [Gateaway(Name = "phone.update", Display = "更新用户手机号")]
    public async Task<object> PhoneUpdate(string phone){
        ...
    }
}
```
